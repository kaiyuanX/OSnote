- [M4](#m4)
  - [实验指南](#实验指南)
      - [把函数编译成共享库](#把函数编译成共享库)
      - [把表达式编译成共享库](#把表达式编译成共享库)
      - [共享库的加载](#共享库的加载)

---

# M4

crepl - 逐行从 stdin 中获取输入，根据内容进行处理

- 一行以 int 开头是函数
  - 它将会经过 gcc 编译，并被加载到当前进程的地址空间中
- 一行不是以 int 开头，我们认为这一行是一个 C 语言的表达式
- 输入不合法的 C 代码，程序应该给出错误提示而不应该 crash

核心代码在 [crep.c](./crep.c)

> 当你在终端里按下 `Ctrl-d`，会结束 stdin 输入流，fgets 会得到 NULL

## 实验指南

#### 把函数编译成共享库

对于一个一行的函数，如何把它编译成共享库？

把这个文件保存到临时文件里，例如 a.c 中，然后使用正确的选项调用 gcc 即可

在 /tmp 中创建临时文件是更安全的做法，不用担心访问权限的问题

此外，glibc 还为我们提供了 mkstemp family API 调用，能够帮助我们生成名称唯一的临时文件

#### 把表达式编译成共享库

做一个 wrapper

每当我们收到一个表达式，例如 `gcd(256, 144)` 的时候，我们都可以 “人工生成” 一段 C 代码

```c
:::C
int __expr_wrapper_4() {
    return gcd(256, 144);
}
```

我们的表达式变成一个函数，我们就可以把它编译成共享库了

#### 共享库的加载

我们可以使用 `dlopen()` 加载共享库